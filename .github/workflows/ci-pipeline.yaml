name: CI Pipeline

on:
  push:
    paths:
      - 'student-api/**' # Trigger only when changes are made in the 'student-api' directory
  workflow_dispatch: # Allow manual triggering of the pipeline

jobs:
  ci-pipeline:
    runs-on: self-hosted
    environment: demo
    steps:
      # Checkout the repository into a specific path
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          path: API_PROJECT

      # Detect the correct working directory
      - name: Detect Working Directory
        id: detect-dir
        shell: pwsh
        run: |
          if (Test-Path "API_PROJECT/API_PROJECT/student-api") {
            echo "WORKING_DIR=API_PROJECT/API_PROJECT/student-api" >> $env:GITHUB_ENV
          } elseif (Test-Path "API_PROJECT/student-api") {
            echo "WORKING_DIR=API_PROJECT/student-api" >> $env:GITHUB_ENV
          } else {
            Write-Error "Error: Could not find the student-api directory."
            exit 1
          }

      # Debug the working directory
      - name: Debug Working Directory
        run: |
          echo "Current Directory: $(pwd)"
          echo "Working Directory: $WORKING_DIR"
          ls -R $WORKING_DIR
        shell: pwsh

      # Build the API
      - name: Build API
        run: make build-api
        working-directory: ${{ env.WORKING_DIR }}

      # Run tests
      - name: Run Tests
        run: |
          if make test; then
            echo "Tests passed."
          else
            echo "Tests failed."
            exit 1
          fi
        working-directory: ${{ env.WORKING_DIR }}

      # Perform code linting
      - name: Code Linting
        run: make lint
        working-directory: ${{ env.WORKING_DIR }}

      # Docker login
      - name: Docker Login
        env:
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
        run: echo "${DOCKER_PASSWORD}" | docker login -u "${DOCKER_USERNAME}" --password-stdin

      # Docker build and push
      - name: Docker Build and Push
        run: |
          docker build -t ${{ secrets.DOCKER_USERNAME }}/student-api:latest .
          docker push ${{ secrets.DOCKER_USERNAME }}/student-api:latest
        working-directory: ${{ env.WORKING_DIR }}